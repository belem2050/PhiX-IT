<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>

    <!-- library  Leaflet for OpenStreetMaps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
    <style type="text/css">
      #map{ 
          height:400px;
      }
    </style>
    <title>Carte</title>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <script type='text/javascript' src='https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js'></script>

    <!-- request ajax API -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 

    <!-- libraries : data visualisation -->
    <script src="https://d3js.org/d3.v3.min.js"></script>  
    <script src="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/wordcloud.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    
    
    <!-- file JavaScript for instructions -->
    <script src="/static/mydashboard.js"></script>
    
    <!-- stylesheet -->
    <link rel="stylesheet" type="text/css" href="/static/dashboard.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/novus/nvd3/v1.8.1/build/nv.d3.css">



  </head>

  <body>
    
    <div class="content">

      <header>
        <div class="header-background"></div>
        <div class="title">
          <h1>
            Detection and prediction of natural catastrophes
          </h1>
        </div>
      </header>

      <main>
        <div class="chartContainer">
          <form action="/city/" method="POST">
            City :<br>
            <input type="text" name="city">
            <input type="submit" value="Go">
        </form>
        </div>
        
        
        

        <div class="chartContainer">

          <div id="Weather" class="chart">
            <text class="chartTitle">Forecaster</text>
            <canvas id="weather"></canvas>
            <svg></svg>
          </div>
          
          <div id="Avalanches" class="chart">
            <text class="chartTitle">Avalanches</text>
              <p id="messageAvalanche"></p>
              <p id="elevationAvalanche"></p>
              <canvas id="avalanche"></canvas>
          </div>
          
          <div id="Flood" class="chart">
            <text class="chartTitle">Flood</text>
            <p id="messageFlood"></p>
            <p id="water_level"></p>
            <canvas id="flood"></canvas>
            <svg></svg>
          </div>

          <div id="Earthquake" class="chart">
            <text class="chartTitle">Earthquake</text>
            <svg></svg>
          </div>

          <div id="Volcanic_Activity" class="chart">
            <text class="chartTitle">Volcanic Activity</text>
            <p id="messageVolcanicActivity"></p>
            <p id="volcanic_ground_temperature"></p>
            <svg></svg>
          </div>

        </div>

        <div id="map">
        </div>

      </main>
    </div>


    <!-- API FORECASTER -->
    <script type="text/javascript">
      $.ajax({
          url: "/api/forecaster/",
          success: display_forecaster
      });
      
      function display_forecaster(result){
          console.log("forecaster :", result);
      }
   </script>

    <!-- API WEATHER -->
    <script>
      $.ajax({
          url: "/api/weather/",
          success: weather_graph
      });

      function weather_graph(result){
        console.log("Api weather :", result);

        const ctx = document.getElementById('weather');

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: result.date,
            datasets: [{
              label: 'Temperature',
              data: result.temp,
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });

      }
    </script>

    <!-- API AVALANCHE -->
    <script type="text/javascript">
      $.ajax({
          url: "/api/avalanche/",
          success: display_avalanche
      });

      function display_avalanche(result){
          console.log("avalanche :", result);

          document.getElementById("messageAvalanche").innerHTML = result.message;
          document.getElementById("elevationAvalanche").innerHTML = "Elevation : " + result.elevation + " m";

          const ctx = document.getElementById('avalanche');

          new Chart(ctx, {
            type: 'line',
            data: {
              //labels: result.snow_history,
              datasets: [{
                label: 'cm',
                data: result.snow_history,
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

      }
   </script>


    <!-- API FLOOD -->
    <script type="text/javascript">
      $.ajax({
          url: "/api/flood/",
          success: display_flood
      });

      function display_flood(result){
          console.log("flood :", result);

          document.getElementById("messageFlood").innerHTML = result.message;
          document.getElementById("water_level").innerHTML = result.water_level;

          const ctx = document.getElementById('flood');

          new Chart(ctx, {
            type: 'line',
            data: {
              label: 'hourly',
              datasets: [{
                label: 'g.m-3',
                data: result.humidity_history,
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

      }
   </script>

   <!-- API VOLCANIC ACTIVITY -->
   <script type="text/javascript">
    $.ajax({
        url: "/api/volcanic_activity/",
        success: display_volcanic_activity
    });
    
    function display_volcanic_activity(result){
        console.log("volcanic_activity :", result);

        document.getElementById("messageVolcanicActivity").innerHTML = result.message;
        document.getElementById("volcanic_ground_temperature").innerHTML = "Volcanic ground temperature : " + result.volcanic_ground_temperature;

    }
 </script>

    <!-- API MAP (SENSORS LOCATION) -->
    <script>

      var sensorsLocation = {
        "Paris": { "lat": 48.852969, "lon": 2.349903 },
        "Brest": { "lat": 48.383, "lon": -4.500 },
        "Quimper": { "lat": 48.000, "lon": -4.100 },
        "Bayonne": { "lat": 43.500, "lon": -1.467 }
      };
      
      // Center map (Paris)
      var lat = 48.852969;
      var lon = 2.349903;
      var mymap = L.map('map').setView([lat, lon], 11);
      var markers = L.markerClusterGroup();
      var tableMarkers = [];

      L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
              attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
              minZoom: 1,
              maxZoom: 20
          }).addTo(mymap);
      
      for(sensor in sensorsLocation){
        var marker = L.marker([sensorsLocation[sensor].lat, sensorsLocation[sensor].lon]);
        marker.bindPopup("<p>"+sensor+"</p>");
        markers.addLayer(marker);
        tableMarkers.push(marker);
      }

      var group = new L.featureGroup(tableMarkers)
      mymap.fitBounds(group.getBounds().pad(0.5));
      mymap.addLayer(markers);

    </script>

  </body>
</html>